{% extends "base.html" %}

{% block title %}Trading Dashboard{% endblock %}

{% block navbar_content %}
    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#" id="dashboard-tab">Dashboard</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" id="backtest-tab">Backtest</a>
        </li>
    </ul>
    <ul class="navbar-nav ms-auto">
        <li class="nav-item">
            <a class="nav-link" href="#">Welcome, <span id="user-name">{{ user_name }}</span></a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/logout">Logout</a>
        </li>
    </ul>
{% endblock %}

{% block content %}
    <div class="container mt-4" id="dashboard-content">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Market Data</h5>
                        <p class="card-text">Nifty: <span id="nifty-price"></span></p>
                        <p class="card-text">Bank Nifty: <span id="banknifty-price"></span></p>
                    </div>
                </div>
                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="card-title">Account</h5>
                        <p class="card-text">Available Balance: <span id="balance">{{ balance }}</span></p>
                        {% if not access_token %}
                        <a href="/zerodha_login" class="btn btn-primary">Login with Zerodha</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Strategy</h5>
                        <div class="mb-3">
                            <label for="strategy-select" class="form-label">Select Strategy</label>
                            <select class="form-select" id="strategy-select">
                                <option value="orb">Opening Range Breakout (ORB)</option>
                            </select>
                        </div>
                        <div id="orb-strategy-form">
                            <form id="strategy-form" action="/strategy/start" method="POST">
                                <input type="hidden" name="strategy" value="orb">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="instrument" class="form-label">Instrument</label>
                                        <select class="form-select" id="instrument" name="instrument">
                                            <option value="NIFTY">NIFTY</option>
                                            <option value="BANKNIFTY">BANKNIFTY</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="candle-time" class="form-label">Candle Time</label>
                                        <select class="form-select" id="candle-time" name="candle-time">
                                            <option value="5">5 minutes</option>
                                            <option value="10">10 minutes</option>
                                            <option value="15">15 minutes</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="start-time" class="form-label">Start Time</label>
                                        <input type="time" class="form-control" id="start-time" name="start-time" value="09:15">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="end-time" class="form-label">End Time</label>
                                        <input type="time" class="form-control" id="end-time" name="end-time" value="15:00">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="stop-loss" class="form-label">Stop Loss (%)</label>
                                        <input type="number" class="form-control" id="stop-loss" name="stop-loss" value="1">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="target-profit" class="form-label">Target Profit (%)</label>
                                        <input type="number" class="form-control" id="target-profit" name="target-profit" value="2">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="quantity" class="form-label">Quantity</label>
                                        <input type="number" class="form-control" id="quantity" name="quantity" value="50">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="trailing-stop-loss" class="form-label">Trailing Stop Loss (%)</label>
                                        <input type="number" class="form-control" id="trailing-stop-loss" name="trailing-stop-loss" value="0.5">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Start Strategy</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="card-title">Live P&L</h5>
                        <p class="card-text">P&L: <span id="pnl">0</span></p>
                    </div>
                </div>
                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="card-title">Active Trade</h5>
                        <button id="square-off-btn" class="btn btn-danger" style="display: none;">Square Off</button>
                    </div>
                </div>
                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="card-title">Running Strategies</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Instrument</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="running-strategies">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4" id="backtest-content" style="display: none;">
        <h2>Backtest Strategy</h2>
        <form id="backtest-form">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="backtest-strategy" class="form-label">Strategy</label>
                    <select class="form-select" id="backtest-strategy" name="strategy">
                        <option value="orb">Opening Range Breakout (ORB)</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="backtest-instrument" class="form-label">Instrument</label>
                    <select class="form-select" id="backtest-instrument" name="instrument">
                        <option value="NIFTY">NIFTY</option>
                        <option value="BANKNIFTY">BANKNIFTY</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="backtest-from-date" class="form-label">From Date</label>
                    <input type="date" class="form-control" id="backtest-from-date" name="from_date">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="backtest-to-date" class="form-label">To Date</label>
                    <input type="date" class="form-control" id="backtest-to-date" name="to_date">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Run Backtest</button>
        </form>
        <div id="backtest-results" class="mt-4"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const dashboardTab = document.getElementById('dashboard-tab');
            const backtestTab = document.getElementById('backtest-tab');
            const dashboardContent = document.getElementById('dashboard-content');
            const backtestContent = document.getElementById('backtest-content');

            dashboardTab.addEventListener('click', () => {
                dashboardContent.style.display = 'block';
                backtestContent.style.display = 'none';
                dashboardTab.classList.add('active');
                backtestTab.classList.remove('active');
            });

            backtestTab.addEventListener('click', () => {
                dashboardContent.style.display = 'none';
                backtestContent.style.display = 'block';
                dashboardTab.classList.remove('active');
                backtestTab.classList.add('active');
            });

            var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

            socket.on('connect', function() {
                socket.emit('my_event', {data: 'I\'m connected!'});
            });

            socket.on('market_data', function(msg) {
                document.getElementById('nifty-price').textContent = msg.nifty_price;
                document.getElementById('banknifty-price').textContent = msg.banknifty_price;
                
                const pnlElement = document.getElementById('pnl');
                pnlElement.textContent = msg.pnl;
                if (msg.pnl > 0) {
                    pnlElement.style.color = 'green';
                } else if (msg.pnl < 0) {
                    pnlElement.style.color = 'red';
                } else {
                    pnlElement.style.color = 'black';
                }
            });

            function fetchRunningStrategies() {
                fetch('/strategies')
                    .then(response => response.json())
                    .then(data => {
                        const strategiesBody = document.getElementById('running-strategies');
                        strategiesBody.innerHTML = '';
                        for (const [id, strategy] of Object.entries(data)) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${id}</td>
                                <td>${strategy.name}</td>
                                <td>${strategy.instrument}</td>
                                <td>${strategy.status}</td>
                                <td><a href="/strategy/cancel/${id}" class="btn btn-danger btn-sm">Cancel</a></td>
                            `;
                            strategiesBody.appendChild(row);
                        }
                    });
            }

            setInterval(fetchRunningStrategies, 5000); // Refresh every 5 seconds

            document.getElementById('backtest-form').addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                fetch('/backtest', { method: 'POST', body: formData })
                    .then(response => response.json())
                    .then(data => {
                        const resultsDiv = document.getElementById('backtest-results');
                        resultsDiv.innerHTML = `
                            <h5>Backtest Results</h5>
                            <p>P&L: ${data.pnl}</p>
                            <p>Number of Trades: ${data.trades}</p>
                        `;
                    });
            });

        });
    </script>
{% endblock %}